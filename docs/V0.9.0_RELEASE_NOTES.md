# Spice Framework v0.9.0 Release Notes

**Release Date:** November 12, 2025
**Type:** Major Release (Breaking Changes)
**Theme:** Type System Modernization

## üéØ Overview

Version 0.9.0 represents a comprehensive modernization of Spice's type system, introducing nullable type support across all metadata and data fields. This breaking change enables more flexible data handling, better JSON compatibility, and improved type safety throughout the framework.

## üî• Breaking Changes

### Map<String, Any?> Migration

All metadata, data, and context fields have been migrated from `Map<String, String>` or `Map<String, Any>` to **`Map<String, Any?>`** to support null values and flexible types.

#### Affected Components

**Core Communication:**
- `Comm.data: Map<String, Any?>` - Now supports null values and native types (Int, Long, Boolean, etc.)
- `MediaItem.metadata: Map<String, Any?>`

**Tool System:**
- `Tool.execute(parameters: Map<String, Any?>)` - All tool implementations must update
- `ToolResult.metadata: Map<String, Any?>`
- `ToolContext.metadata: Map<String, Any?>`
- `AgentTool.metadata` and `implementationDetails: Map<String, Any?>`

**Graph Execution:**
- `HumanResponse.metadata: Map<String, Any?>`
- `NodeResult.metadata: Map<String, Any?>` - With automatic null filtering
- `NodeContext.state: PersistentMap<String, Any?>`

**Handoff System:**
- `HandoffRequest.metadata: Map<String, Any?>`
- `HandoffTask.context: Map<String, Any?>`
- `HandoffResponse.metadata: Map<String, Any?>`

**Vector Store:**
- `TextDocument.metadata: Map<String, Any?>`
- `TextSearchResult.metadata: Map<String, Any?>`
- `VectorStore.storeText(metadata: Map<String, Any?>)`

**Event Sourcing:**
- `Snapshot.metadata: Map<String, Any?>`

**Registry & Execution:**
- `ToolWrapperEx.metadata: Map<String, Any?>`
- `ToolResultWithMeta.metadata: Map<String, Any?>`
- `AgentResult.data: Map<String, Any?>`

### New Serialization

Introduced `AnyValueMapSerializer` for kotlinx.serialization support:
- Handles null values with `JsonNull`
- Supports primitive types: String, Number, Boolean
- Supports collections: List, Array
- Automatic type conversion for complex types

### Safe Accessor Functions

Added type-safe accessor methods to `Comm`:

```kotlin
// Safe type conversion with null safety
fun Comm.getDataAsString(key: String): String?
fun Comm.getDataAsBoolean(key: String): Boolean?
fun Comm.getDataAsInt(key: String): Int?
fun Comm.getDataAsLong(key: String): Long?
fun Comm.getDataAsDouble(key: String): Double?
```

## ‚ú® New Features

### 1. Flexible Metadata Storage

Store native types without string conversion:

```kotlin
// ‚úÖ NEW: Native types
comm.withData("count", 42)                    // Int
comm.withData("score", 0.95)                  // Double
comm.withData("enabled", true)                // Boolean
comm.withData("tags", listOf("ai", "ml"))     // List
comm.withData("optional", null)               // Null

// ‚ùå OLD: Everything as strings
comm.withData("count", "42")
comm.withData("score", "0.95")
comm.withData("enabled", "true")
```

### 2. Type-Safe Access Patterns

```kotlin
// ‚úÖ GOOD: Safe accessor
val count = comm.getDataAsInt("count") ?: 0
val enabled = comm.getDataAsBoolean("enabled") == true

// ‚ö†Ô∏è UNSAFE: Direct cast (use with caution)
val count = comm.data["count"] as? Int
```

### 3. VectorStore Type Support

Vector metadata now supports rich types:

```kotlin
vectorStore.storeText(
    collectionName = "articles",
    id = "article-123",
    text = "Kotlin is awesome",
    metadata = mapOf(
        "author" to "John Doe",        // String
        "wordCount" to 1500,            // Int
        "rating" to 4.5,                // Double
        "published" to true,            // Boolean
        "tags" to listOf("kotlin", "programming")  // List
    )
)
```

### 4. Improved Tool Parameter Handling

Tools can now receive properly typed parameters:

```kotlin
override suspend fun execute(params: Map<String, Any?>): SpiceResult<ToolResult> {
    // ‚úÖ Safe conversion with validation
    val name = params["name"]?.toString()
        ?: return SpiceResult.failure("Missing 'name'")

    val age = (params["age"] as? Number)?.toInt()
        ?: return SpiceResult.failure("Missing 'age'")

    val active = params["active"] as? Boolean ?: true

    // Process with native types...
}
```

## üîß Migration Guide

### Step 1: Update Tool Implementations

**Before (v0.8.x):**
```kotlin
class MyTool : Tool {
    override suspend fun execute(parameters: Map<String, Any>): SpiceResult<ToolResult> {
        val name = parameters["name"] as String  // Unsafe cast
        // ...
    }
}
```

**After (v0.9.0):**
```kotlin
class MyTool : Tool {
    override suspend fun execute(parameters: Map<String, Any?>): SpiceResult<ToolResult> {
        val name = parameters["name"]?.toString()
            ?: return SpiceResult.failure("Missing 'name'")
        // ...
    }
}
```

### Step 2: Update Data Access Patterns

**Before:**
```kotlin
// String-only access
val value = comm.data["key"]  // Always String
val count = comm.data["count"]?.toIntOrNull() ?: 0
```

**After:**
```kotlin
// Type-safe accessors
val value = comm.getDataAsString("key")
val count = comm.getDataAsInt("count") ?: 0
val enabled = comm.getDataAsBoolean("enabled") == true
```

### Step 3: Update Metadata Construction

**Before:**
```kotlin
ToolResult.success(
    result = "Done",
    metadata = mapOf(
        "count" to results.size.toString(),  // Force to string
        "success" to "true"
    )
)
```

**After:**
```kotlin
ToolResult.success(
    result = "Done",
    metadata = mapOf(
        "count" to results.size,      // Native Int
        "success" to true,             // Native Boolean
        "timestamp" to System.currentTimeMillis()  // Native Long
    )
)
```

### Step 4: Update Serializable Data Classes

**Before:**
```kotlin
@Serializable
data class MyData(
    val metadata: Map<String, String> = emptyMap()
)
```

**After:**
```kotlin
@Serializable
data class MyData(
    @Serializable(with = AnyValueMapSerializer::class)
    val metadata: Map<String, Any?> = emptyMap()
)
```

## üé® Best Practices

### Type Safety Patterns

```kotlin
// ‚úÖ EXCELLENT: Safe accessor with default
val userId = comm.getDataAsString("userId") ?: "anonymous"

// ‚úÖ GOOD: Elvis operator with error
val tenantId = params["tenantId"]?.toString()
    ?: throw IllegalArgumentException("Missing tenantId")

// ‚úÖ GOOD: Safe cast with validation
val age = (params["age"] as? Number)?.toInt()
    ?: return Result.failure("Invalid age")

// ‚ùå BAD: Unsafe cast (runtime exception risk)
val userId = comm.data["userId"] as String
```

### Null Handling

```kotlin
// Nullable values are now supported
comm.withData("optional", null)  // ‚úÖ Valid

// Check for null explicitly
val value = comm.data["key"]
if (value != null) {
    // Process non-null value
}
```

### Complex Types

```kotlin
// Lists and nested structures
metadata = mapOf(
    "tags" to listOf("ai", "ml", "nlp"),
    "scores" to mapOf("accuracy" to 0.95, "precision" to 0.92),
    "config" to MyConfig(...)  // Will be toString()'d
)
```

## üìä Impact Analysis

### Statistics
- **43 files modified** in spice-core
- **27 test files updated** for type safety
- **23 unsafe casts eliminated** in test code
- **0 runtime behavior changes** for valid code

### Test Results
- ‚úÖ **384 tests** executed
- ‚úÖ **364 passing** (94.8%)
- ‚ö†Ô∏è **20 failing** (pre-existing, unrelated to migration)

### Compatibility
- **Binary incompatible** with v0.8.x
- **Source incompatible** for Tool implementations
- **Runtime compatible** for most common use cases

## üîç Implementation Details

### AnyValueMapSerializer

Custom kotlinx.serialization serializer supporting:

```kotlin
object AnyValueMapSerializer : KSerializer<Map<String, Any?>> {
    // Serialize: Any? ‚Üí JsonElement
    // - null ‚Üí JsonNull
    // - String ‚Üí JsonPrimitive(String)
    // - Number ‚Üí JsonPrimitive(Number)
    // - Boolean ‚Üí JsonPrimitive(Boolean)
    // - List<*> ‚Üí JsonArray
    // - else ‚Üí toString()

    // Deserialize: JsonElement ‚Üí Any?
    // - JsonNull ‚Üí null
    // - JsonPrimitive ‚Üí appropriate type
    // - JsonArray ‚Üí List
    // - JsonObject ‚Üí Map
}
```

### NodeResult Null Filtering

`NodeResult.metadata` automatically filters null values to maintain non-null type:

```kotlin
fun fromContext(
    ctx: NodeContext,
    data: Any?,
    additional: Map<String, Any?> = emptyMap()
): NodeResult {
    val merged = (ctx.context.toMap() + additional)
        .filterValues { it != null } as Map<String, Any>
    return NodeResult(data, merged)
}
```

## üìö Documentation Updates

All documentation has been updated to reflect the new type system:

- **API Reference**: Updated all method signatures
- **DSL Guide**: New examples with native types
- **Migration Guide**: Comprehensive migration instructions
- **Best Practices**: Type safety patterns and recommendations

## üöÄ Upgrade Path

### Recommended Approach

1. **Update dependencies** to v0.9.0
2. **Run compilation** to identify affected code
3. **Update Tool implementations** to accept `Map<String, Any?>`
4. **Replace unsafe casts** with safe accessors
5. **Update metadata construction** to use native types
6. **Add `@Serializable(with = AnyValueMapSerializer::class)` annotations**
7. **Test thoroughly** with your use cases

### Automated Migration

For large codebases, consider:

```kotlin
// Find all unsafe casts
params\["(\w+)"\] as (\w+)

// Replace with safe pattern
params["$1"]?.toString() ?: throw IllegalArgumentException("Missing '$1'")
```

## üêõ Known Issues

None at this time.

## üôè Acknowledgments

This major refactoring ensures Spice Framework remains modern, type-safe, and flexible for the next generation of AI applications.

## üìû Support

- **GitHub Issues**: [https://github.com/no-ai-labs/spice/issues](https://github.com/no-ai-labs/spice/issues)
- **Documentation**: [https://spice-framework-docs.pages.dev](https://spice-framework-docs.pages.dev)
- **Discord**: Coming soon

## üéØ What's Next?

Version 0.9.1 will focus on:
- Enhanced type validation utilities
- Additional safe accessor methods
- Performance optimizations for serialization
- Community feedback integration

---

**Full Changelog**: [v0.8.2...v0.9.0](https://github.com/no-ai-labs/spice/compare/v0.8.2...v0.9.0)
