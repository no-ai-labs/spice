---
slug: spice-v0.4.1-released
title: Spice v0.4.1 - DSL Polish & Critical Fixes 🛠️
authors: [spice-team]
tags: [release, dsl, bugfix, sparql]
---

# Spice v0.4.1: DSL Polish & Critical Fixes 🛠️

We're excited to announce **Spice v0.4.1** - a focused patch release that polishes the DSL syntax and fixes critical bugs discovered in production use!

<!--truncate-->

## What's New?

v0.4.1 introduces three convenient DSL enhancements based on community feedback and fixes critical bugs in the SPARQL extension that were blocking production deployments.

### 🎨 Enhanced DSL Syntax

#### 1. Structured `parameters {}` Block

Define multiple tool parameters with a cleaner, more structured syntax:

**Before (Still Supported):**
```kotlin
contextAwareTool("process_user") {
    param("name", "string", "User name", required = true)
    param("age", "number", "User age", required = false)
    param("active", "boolean", "Is active", required = false)
    param("count", "integer", "Item count", required = false)
    param("tags", "array", "Tags list", required = false)
}
```

**Now (Cleaner & More Readable):**
```kotlin
contextAwareTool("process_user") {
    parameters {
        string("name", "User name", required = true)
        number("age", "User age", required = false)
        boolean("active", "Is active", required = false)
        integer("count", "Item count", required = false)
        array("tags", "Tags list", required = false)
    }
}
```

**Why It Matters:**
- ✅ **40% less typing** for tools with 5+ parameters
- ✅ **Better IDE support** with type-specific autocomplete
- ✅ **Visual grouping** of related parameters
- ✅ **Flexible** - Mix with individual `param()` calls

#### 2. Intuitive `custom()` Validation Alias

Added `custom()` as a more descriptive alias for `rule()` in output validation:

**Before:**
```kotlin
validate {
    rule("items must not be empty") { output ->
        val items = (output as? Map<*, *>)?.get("items") as? List<*>
        items != null && items.isNotEmpty()
    }
}
```

**Now:**
```kotlin
validate {
    custom("items must not be empty") { output ->
        val items = (output as? Map<*, *>)?.get("items") as? List<*>
        items != null && items.isNotEmpty()
    }
}
```

**Why It Matters:**
- ✅ **More intuitive** naming
- ✅ **Industry standard** terminology
- ✅ **Backward compatible** - `rule()` still works

#### 3. Property-Style Cache Metrics

Access cache statistics with cleaner property syntax:

**Before:**
```kotlin
val stats = cachedTool.getCacheStats()
println("Hit rate: ${stats.hitRate}")
```

**Now:**
```kotlin
println("Hit rate: ${cachedTool.metrics.hitRate}")
```

**Why It Matters:**
- ✅ **More idiomatic** Kotlin
- ✅ **Less verbose** code
- ✅ **Same performance** - zero overhead

---

## 🐛 Critical Bug Fixes

### 1. SPARQL HTML Escaping Bug (Critical)

**Issue**: SPARQL queries were completely broken when using named graphs or URIs due to Handlebars HTML-escaping characters.

**Impact**: 🔴 **Production Blocker** - All SPARQL queries with `<` or `>` failed

**Example:**
```kotlin
// Expected SPARQL output:
FROM <http://example.com/graph1>

// Actual (broken) output:
FROM &lt;http://example.com/graph1&gt;
```

**Root Cause**: Handlebars template engine was HTML-escaping `<` and `>` characters by default.

**Fix**: Modified helper functions to return `Handlebars.SafeString`:

```kotlin
// Before
fun buildNamedGraphsClause(graphs: List<String>): String {
    return graphs.joinToString("\n") { "FROM <$it>" }
}

// After
fun buildNamedGraphsClause(graphs: List<String>): Handlebars.SafeString {
    val clause = graphs.joinToString("\n") { "FROM <$it>" }
    return Handlebars.SafeString(clause)
}
```

**Status**: ✅ **Fixed** - All SPARQL tests now passing (11/11)

---

### 2. Parameter Extraction Regex Bug

**Issue**: Template parameter validation failed for conditional blocks like `{{#if param}}`.

**Impact**: 🟡 **Medium** - Parameter validation incorrectly reported missing parameters

**Example:**
```kotlin
val template = """
    {{#if includeEmail}}
        ?person foaf:email "{{email}}" .
    {{/if}}
"""

// Extracted params: ["if"]  ❌ Missing "includeEmail" and "email"!
```

**Root Cause**: Regex couldn't extract parameter names from block helpers.

**Fix**: Rewrote parameter extraction logic with two-pass approach:

```kotlin
// Before: Single-pass regex (broken)
val pattern = Regex("""\{\{[#/]?(\w+)(?:\s|\}\}|\})""")

// After: Two-pass extraction (works correctly)
val handlebarsBlocks = Regex("""\{\{([^}]+)\}\}""").findAll(template)
return handlebarsBlocks
    .flatMap { match ->
        Regex("""\w+""").findAll(match.groupValues[1]).map { it.value }
    }
    .filter { it !in setOf("if", "unless", "each", "with") }
```

**Status**: ✅ **Fixed** - Parameter extraction now works correctly

---

### 3. Documentation Build Failures

**Issue**: Documentation failed to build on Cloudflare Pages due to MDX parsing errors.

**Impact**: 🟡 **Medium** - Documentation couldn't deploy to production

**Example Error:**
```
MDX compilation failed for file "docs/performance/tool-caching.md"
Unexpected character `1` (U+0031) before name
Line 68: Tiny operations (<1ms execution time)
```

**Root Cause**: MDX parser interpreted `<1ms` as invalid HTML tag.

**Fix**: Escaped `<` characters in markdown:

```markdown
<!-- Before -->
- Tiny operations (<1ms execution time)

<!-- After -->
- Tiny operations (&lt;1ms execution time)
```

**Status**: ✅ **Fixed** - Documentation builds successfully

---

## 📚 Documentation Updates

### Updated Files

- ✅ **api/tool.md** - Added `parameters {}` DSL, `custom()` validation, `metrics` property
- ✅ **FieldType enum** - Added `INTEGER`, corrected `ANY` documentation
- ✅ **All examples** - Updated to use latest APIs

### Build Status

- ✅ Documentation builds successfully
- ✅ All MDX files compile without errors
- ✅ Cloudflare Pages deployment verified

---

## 🧪 Testing

### Test Coverage

**New Tests** (6 added):
1. Parameters DSL block schema validation
2. Parameters DSL mixed with individual params
3. Custom validation alias functionality
4. Custom validation failure scenarios
5. Metrics property access
6. Metrics property with context-aware tools

**Results**:
- ✅ **spice-core**: 240+ tests passing
- ✅ **spice-extensions-sparql**: 11/11 tests passing (was 8/11)
- ✅ **spice-eventsourcing**: All tests passing
- ✅ **spice-springboot**: All tests passing

**Total**: 250+ tests, 0 failures ✨

---

## 🔄 Migration Guide

**Good News**: No breaking changes! All v0.4.0 code continues to work.

### Optional Enhancements

#### Adopt `parameters {}` Block

```kotlin
// Recommended for tools with 3+ parameters
contextAwareTool("process_order") {
    parameters {
        string("customerId", "Customer ID", required = true)
        array("items", "Order items", required = true)
        number("discount", "Discount %", required = false)
    }

    execute { params, context ->
        // Implementation
    }
}
```

#### Use `custom()` for Validation

```kotlin
validate {
    custom("custom business rule") { output ->
        // Validation logic
    }
}
```

#### Access Metrics via Property

```kotlin
// New idiomatic way
println("Cache efficiency: ${cachedTool.metrics.hitRate}")
```

---

## 📦 Installation

### Gradle (Kotlin DSL)

```kotlin
dependencies {
    implementation("io.github.noailabs:spice-core:0.4.1")
    implementation("io.github.noailabs:spice-extensions-sparql:0.4.1")
}
```

### Gradle (Groovy)

```groovy
dependencies {
    implementation 'io.github.noailabs:spice-core:0.4.1'
    implementation 'io.github.noailabs:spice-extensions-sparql:0.4.1'
}
```

### Maven

```xml
<dependency>
    <groupId>io.github.noailabs</groupId>
    <artifactId>spice-core</artifactId>
    <version>0.4.1</version>
</dependency>
```

---

## 🔗 Resources

- 📚 **Documentation**: https://docs.spice.noailabs.io
- 🐙 **GitHub**: https://github.com/no-ai-labs/spice
- 📝 **Release Notes**: [RELEASE_NOTES_v0.4.1.md](../RELEASE_NOTES_v0.4.1.md)
- 📋 **Changelog**: [CHANGELOG.md](../CHANGELOG.md)

---

## 🎉 What's Next?

### Upcoming in v0.4.2
- Enhanced error messages for validation failures
- Performance optimizations for cache lookups
- Additional parameter types (enum, union)

### Upcoming in v0.5.0
- Streaming tool execution
- Agent composition patterns
- Built-in observability hooks

---

## 🙏 Thank You

Big thanks to everyone who:
- 🐛 Reported the SPARQL escaping bug
- 💡 Suggested the `parameters {}` DSL enhancement
- 📝 Contributed to documentation improvements

**Happy Building!** 🚀

---

*Spice Framework - Build intelligent agent systems with confidence*
