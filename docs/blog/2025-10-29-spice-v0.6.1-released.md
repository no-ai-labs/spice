---
slug: spice-v0.6.1-released
title: Spice 0.6.1 Released - ExecutionContext Accessor API
authors: [spice-team]
tags: [release, execution-context, accessor-api]
---

# Spice 0.6.1: Service Layer Made Easy üéØ

Hot on the heels of 0.6.0, we're releasing **Spice 0.6.1** with a small but powerful addition: **ExecutionContext accessor functions**.

<!-- truncate -->

## üéØ What's New

### ExecutionContext Accessor API

Remember having to pass context everywhere?

```kotlin
// Before - context parameter hell
suspend fun processOrder(orderId: String, context: ExecutionContext) {
    val tenantId = context.tenantId ?: error("No tenant")
    validateOrder(orderId, context)  // Pass it down
    saveOrder(orderId, context)      // Pass it down
    auditLog(orderId, context)       // Pass it down
}
```

**No more!** 

```kotlin
// After - clean service layer
suspend fun processOrder(orderId: String) {
    val tenantId = getCurrentTenantId() ?: error("No tenant")
    validateOrder(orderId)  // Context auto-available
    saveOrder(orderId)      // Context auto-available
    auditLog(orderId)       // Context auto-available
}
```

---

## üöÄ New Functions

### Five New Accessors

```kotlin
// 1. Get full context
val context = currentExecutionContext()  // Returns null if not in scope

// 2. Require context (throws if missing)
val context = requireExecutionContext()  // Throws IllegalStateException

// 3. Direct tenant ID
val tenantId = getCurrentTenantId()  // Most convenient!

// 4. Direct user ID
val userId = getCurrentUserId()

// 5. Direct correlation ID
val correlationId = getCurrentCorrelationId()
```

---

## üí° Real-World Examples

### Example 1: Multi-Tenant Repository

```kotlin
class OrderRepository {
    suspend fun findAll(): List<Order> {
        val tenantId = getCurrentTenantId() ?: error("No tenant")
        return database.query(
            "SELECT * FROM orders WHERE tenant_id = ?",
            tenantId
        )
    }
    
    suspend fun save(order: Order): Order {
        val tenantId = getCurrentTenantId() ?: error("No tenant")
        val userId = getCurrentUserId()
        
        return database.insert(
            order.copy(
                tenantId = tenantId,
                createdBy = userId
            )
        )
    }
}
```

### Example 2: Audit Logging

```kotlin
class AuditLogger {
    suspend fun log(action: String, details: Map<String, Any>) {
        auditLog.write(
            action = action,
            details = details,
            tenantId = getCurrentTenantId(),
            userId = getCurrentUserId(),
            correlationId = getCurrentCorrelationId(),
            timestamp = Instant.now()
        )
    }
}

// Usage - no context parameter needed!
suspend fun deleteOrder(orderId: String) {
    orderRepository.delete(orderId)
    auditLogger.log("order.deleted", mapOf("orderId" to orderId))
}
```

### Example 3: Authorization

```kotlin
class AuthService {
    suspend fun requirePermission(permission: String) {
        val userId = getCurrentUserId() 
            ?: throw UnauthorizedException("No user context")
        val tenantId = getCurrentTenantId() 
            ?: throw UnauthorizedException("No tenant context")
        
        if (!permissionService.hasPermission(userId, tenantId, permission)) {
            throw ForbiddenException("Missing permission: $permission")
        }
    }
}

// Usage
suspend fun deleteOrder(orderId: String) {
    authService.requirePermission("orders.delete")  // Implicit context!
    orderRepository.delete(orderId)
}
```

---

## üîÑ Enhanced DSL

### withAgentContext Upgrade

The `withAgentContext` DSL now sets **both** AgentContext (0.4.0+) and ExecutionContext (0.6.0+):

```kotlin
withAgentContext("tenantId" to "ACME", "userId" to "user-123") {
    // All these work now!
    val ctx1 = currentAgentContext()       // AgentContext (legacy)
    val ctx2 = currentExecutionContext()   // ExecutionContext (new)
    val tenantId = getCurrentTenantId()    // Convenient accessor
    
    // Service layer just works
    orderService.processOrder(orderId)
}
```

**Benefit:** Backward compatible with 0.5.x code while enabling 0.6.x patterns.

---

## üéì When to Use What

### In Nodes

```kotlin
class MyNode : Node {
    override suspend fun run(ctx: NodeContext): SpiceResult<NodeResult> {
        // ‚úÖ Use NodeContext.context (already have it)
        val tenantId = ctx.context.tenantId
        
        return SpiceResult.success(NodeResult.fromContext(ctx, data = result))
    }
}
```

### In Services

```kotlin
suspend fun myService() {
    // ‚úÖ Use accessor functions (no context parameter needed)
    val tenantId = getCurrentTenantId()
    val userId = getCurrentUserId()
}
```

### In Middleware

```kotlin
class MyMiddleware : Middleware {
    override suspend fun onStart(ctx: RunContext, next: suspend () -> Unit) {
        // ‚úÖ Use RunContext.context (already have it)
        val tenantId = ctx.context.tenantId
        next()
    }
}
```

---

## üì¶ Upgrade

### Installation

```kotlin
// build.gradle.kts
dependencies {
    implementation("com.github.no-ai-labs.spice-framework:spice-core:0.6.1")
}
```

### Migration

If you're on 0.6.0:
- ‚úÖ **No breaking changes**
- ‚úÖ Drop-in replacement
- ‚úÖ Start using new accessors immediately

If you're on 0.5.x:
- See [0.6.0 Release](/blog/spice-v0.6.0-released) first

---

## üôè Thank You

This feature was inspired by real-world usage feedback. Thank you to everyone building production applications with Spice!

---

**Happy Building! üå∂Ô∏è**

*- The Spice Team*

