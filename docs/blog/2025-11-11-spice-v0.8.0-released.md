---
slug: spice-v0.8.0-released
title: Spice 0.8.0 Released - DynamicHumanNode for Agent-Generated Prompts
authors: [spice-team]
tags: [release, feature, hitl, human-in-the-loop, dynamic-prompts]
---

# Your Agent Just Generated a Menu. Now What?

Your AI agent fetched 47 hotel reservations and needs the user to pick one. Do you:
1. Hardcode "Select a reservation" and pray? üò¨
2. Return a static list and lose context? üò≠
3. **Let the agent generate the menu dynamically?** ‚ú®

Spice 0.8.0 introduces **DynamicHumanNode** - finally, your agents can generate prompts at runtime.

<!-- truncate -->

## TL;DR

**Update now:**
```kotlin
implementation("com.github.no-ai-labs.spice-framework:spice-core:0.8.0")
```

**Before (Static Prompt):**
```kotlin
humanNode(
    id = "select",
    prompt = "Select a reservation"  // ‚ùå Where's the list?
)
```

**After (Dynamic Prompt):**
```kotlin
dynamicHumanNode(
    id = "select",
    promptKey = "menu_text",  // ‚úÖ Agent generates this!
    fallbackPrompt = "Please make a selection"
)
```

**What changed:**
- ‚úÖ Agents generate prompts at runtime
- ‚úÖ Seamless checkpoint/resume support
- ‚úÖ Zero breaking changes

---

## The Problem: Static Prompts in Dynamic Workflows

You're building a hotel booking cancellation agent. The workflow:

1. **Fetch** user's reservations (could be 1, could be 50)
2. **Ask** user to select one
3. **Cancel** the selected reservation

### Current Approach (0.7.x): Awkward Workarounds

```kotlin
val graph = graph("cancel-reservation") {
    agent("list", listAgent)  // Fetches 47 reservations

    // üò¨ Problem: Static prompt doesn't show the list!
    humanNode(
        id = "select",
        prompt = "Select a reservation to cancel"
        // User sees: "Select a reservation to cancel"
        // User thinks: "...from what list??"
    )

    agent("cancel", cancelAgent)
}
```

**The disconnect:**
- Agent fetches dynamic data ‚úÖ
- HumanNode uses static prompt ‚ùå
- User is confused üòµ

**Previous workarounds:**
1. Return the list in the agent response (loses HITL pause)
2. Use free-text input (error-prone)
3. Generate options programmatically (coupling nightmare)

---

## The Solution: DynamicHumanNode

```kotlin
val graph = graph("cancel-reservation") {
    // Agent generates menu and stores in metadata
    agent("list", listAgent)

    // DynamicHumanNode reads menu from execution context
    dynamicHumanNode(
        id = "select",
        promptKey = "menu_text",  // üî• Reads from agent's output!
        fallbackPrompt = "Please make a selection"
    )

    agent("cancel", cancelAgent)
}

// In the listAgent:
class ListReservationsAgent : Agent {
    override suspend fun processComm(comm: Comm): SpiceResult<Comm> {
        val reservations = fetchReservations(comm)

        // üéØ Generate dynamic menu
        val menuText = buildString {
            appendLine("Which reservation do you want to cancel?")
            appendLine()
            reservations.forEachIndexed { i, res ->
                appendLine("${i + 1}. ${res.hotel} | ${res.checkIn} to ${res.checkOut}")
            }
        }

        return SpiceResult.success(
            comm.reply(
                content = "Found ${reservations.size} reservations",
                from = id,
                data = mapOf(
                    "menu_text" to menuText,  // üî• Stored for DynamicHumanNode!
                    "reservations_json" to reservations.toJson()
                )
            )
        )
    }
}
```

**User now sees:**
```
Which reservation do you want to cancel?

1. Jeju Ocean View | 2025-12-01 to 2025-12-03
2. Gangneung Healing | 2025-11-15 to 2025-11-17
...
```

**Perfect.**

---

## How It Works: Prompt Resolution

`DynamicHumanNode` checks 3 sources in priority order:

1. **`ctx.state[promptKey]`** - Direct state updates
2. **`ctx.context.get(promptKey)`** - Metadata from AgentNode
3. **`fallbackPrompt`** - Default if key not found

```kotlin
override suspend fun run(ctx: NodeContext): SpiceResult<NodeResult> {
    val dynamicPrompt = (ctx.state[promptKey] as? String)
        ?: (ctx.context.get(promptKey) as? String)
        ?: fallbackPrompt

    // Display to user
    HumanInteraction(
        nodeId = id,
        prompt = dynamicPrompt  // üéØ Runtime-generated prompt!
    )
}
```

This multi-source lookup ensures:
- ‚úÖ Works with direct state updates
- ‚úÖ Works with agent metadata propagation
- ‚úÖ Works across checkpoint/resume boundaries
- ‚úÖ Graceful fallback if data missing

---

## Checkpoint/Resume: It Just Works‚Ñ¢

**Turn 1: Agent generates menu, graph pauses**
```kotlin
val pausedReport = runner.runWithCheckpoint(
    graph = workflowGraph,
    input = mapOf("userId" to "user123"),
    store = checkpointStore
).getOrThrow()

// Checkpoint automatically saves:
// ‚úÖ state["menu_text"]
// ‚úÖ context["menu_text"]
// ‚úÖ context["reservations_json"]
```

**Turn 2: User selects, graph resumes**
```kotlin
val finalReport = runner.resumeWithHumanResponse(
    graph = workflowGraph,
    checkpointId = pausedReport.checkpointId!!,
    response = HumanResponse.text("select", "1"),
    store = checkpointStore
).getOrThrow()

// DynamicHumanNode restores menu_text from checkpoint
// Next agent accesses reservations_json from restored context
// Everything flows naturally ‚ú®
```

No manual restoration. No special handling. Just works.

---

## Use Cases

### 1. Agent-Generated Selection Menus

```kotlin
dynamicHumanNode(
    id = "pick-item",
    promptKey = "selection_menu"
)
```

**Examples:**
- "Which reservation do you want to cancel?"
- "Select a product to view details:"
- "Choose a payment method:"

### 2. Context-Aware Approval Prompts

```kotlin
agent("analyze-risk", riskAgent)  // Sets risk_level
dynamicHumanNode(
    id = "approve",
    promptKey = "approval_prompt"  // "‚ö†Ô∏è HIGH RISK - Approve?"
)
```

### 3. Personalized Follow-Up Questions

```kotlin
agent("understand-intent", intentAgent)  // Generates specific question
dynamicHumanNode(
    id = "clarify",
    promptKey = "clarification_prompt"
)
```

### 4. Multi-Turn Workflows

```kotlin
agent("list-categories", categoryAgent)
dynamicHumanNode("select-category", promptKey = "category_menu")

agent("list-items", itemAgent)
dynamicHumanNode("select-item", promptKey = "item_menu")

agent("confirm", confirmAgent)
```

---

## Under the Hood: Data Propagation Fixes

This release includes critical bug fixes for checkpoint/resume scenarios.

### Bug Fix 1: ExecutionContext Merging

**Problem:** When resuming from checkpoint, `comm.context` data was ignored.

**Root Cause:**
```kotlin
// Before (0.7.x)
fun Comm.toThinkingContext(): ThinkingContext {
    return ThinkingContext(
        metadata = data  // ‚ùå Only reads comm.data!
    )
}
```

**Fixed (0.8.0):**
```kotlin
fun Comm.toThinkingContext(): ThinkingContext {
    val mergedMetadata = buildMap<String, String> {
        // Priority 1: ExecutionContext (from checkpoint)
        context?.toMap()?.forEach { (k, v) -> put(k, v.toString()) }
        // Priority 2: comm.data (direct metadata)
        putAll(data)
    }
    return ThinkingContext(metadata = mergedMetadata)  // ‚úÖ Full context!
}
```

### Bug Fix 2: Data Restoration Priority

**Problem:** `restoreJsonDataFromSession()` checked SessionState before ExecutionContext.

**Fixed:** Now checks `comm.context` first, SessionState second.

**Impact:** Resolves data loss in multi-turn HITL workflows.

---

## Migration from 0.7.x

**Zero breaking changes.** Update dependency and start using `DynamicHumanNode`.

### Existing Code Continues to Work

```kotlin
// ‚úÖ Still works in 0.8.0
humanNode(
    id = "approve",
    prompt = "Approve?"
)
```

### Adopting DynamicHumanNode

**Before:**
```kotlin
agent("list", listAgent)
humanNode(
    id = "select",
    prompt = "Select an item"  // Static
)
```

**After:**
```kotlin
agent("list", listAgent)
dynamicHumanNode(
    id = "select",
    promptKey = "menu_text",  // Dynamic
    fallbackPrompt = "Please make a selection"
)
```

**Update your agent to set `menu_text` in `comm.data`:**
```kotlin
comm.reply(
    content = "Found items",
    from = id,
    data = mapOf("menu_text" to generatedMenu)
)
```

---

## API Reference

```kotlin
// DSL Function
fun GraphBuilder.dynamicHumanNode(
    id: String,
    promptKey: String = "menu_text",
    fallbackPrompt: String = "ÏÇ¨Ïö©Ïûê ÏûÖÎ†•ÏùÑ Í∏∞Îã§Î¶ΩÎãàÎã§...",
    options: List<HumanOption> = emptyList(),
    timeout: Duration? = null,
    validator: ((HumanResponse) -> Boolean)? = null,
    allowFreeText: Boolean = options.isEmpty()
)

// Node Class
class DynamicHumanNode(
    override val id: String,
    private val promptKey: String,
    private val fallbackPrompt: String,
    val options: List<HumanOption>,
    val timeout: Duration?,
    val validator: ((HumanResponse) -> Boolean)?,
    val allowFreeText: Boolean
) : Node
```

---

## What's Next

**v0.9.0 Preview:**
- Enhanced parallel execution with nested graphs
- Multi-agent coordination patterns
- Advanced retry strategies

**v1.0.0 Roadmap:**
- Production stability guarantees
- Performance benchmarks
- Enterprise support

---

## Try It Now

```kotlin
// build.gradle.kts
dependencies {
    implementation("com.github.no-ai-labs.spice-framework:spice-core:0.8.0")
}
```

**Documentation:**
- [DynamicHumanNode Guide](/docs/orchestration/graph-hitl#2-dynamichumannode-added-in-080)
- [HITL Pattern Overview](/docs/orchestration/graph-hitl)
- [Full Release Notes](/V0.8.0_RELEASE_NOTES.md)

**Example Projects:**
- [Reservation Cancellation Workflow](https://github.com/no-ai-labs/spice-examples/tree/main/dynamic-human-node)

---

## Join the Community

- üêõ [Report Issues](https://github.com/no-ai-labs/spice/issues)
- üí¨ [Discussions](https://github.com/no-ai-labs/spice/discussions)
- üìñ [Documentation](https://spice-framework.dev)

**Happy building!** üå∂Ô∏è‚ú®
