---
slug: spice-v0.9.0-released
title: Spice Framework v0.9.0 - Type System Modernization
authors: [spice-team]
tags: [release, breaking-change, type-system, metadata]
---

# Spice Framework v0.9.0: A Modern Type System for the AI Era

We're excited to announce **Spice Framework v0.9.0**, our most significant update yet! This major release introduces comprehensive type system modernization, bringing nullable type support across all metadata and data fields.

<!-- truncate -->

## Why This Matters

Until now, Spice's metadata system was constrained to string-only values or non-nullable types. This meant you had to convert everything to strings:

```kotlin
// ‚ùå OLD: Everything as strings
comm.withData("count", "42")
comm.withData("score", "0.95")
comm.withData("enabled", "true")

// Then manually parse them back
val count = comm.data["count"]?.toIntOrNull() ?: 0
val score = comm.data["score"]?.toDoubleOrNull() ?: 0.0
```

**Version 0.9.0 changes everything.** Now you can store native types directly:

```kotlin
// ‚úÖ NEW: Native types with null safety
comm.withData("count", 42)                    // Int
comm.withData("score", 0.95)                  // Double
comm.withData("enabled", true)                // Boolean
comm.withData("tags", listOf("ai", "ml"))     // List
comm.withData("optional", null)               // Null

// Type-safe access
val count = comm.getDataAsInt("count") ?: 0
val enabled = comm.getDataAsBoolean("enabled") == true
```

## What Changed: Map&lt;String, Any?&gt;

The core change is simple but powerful: **all metadata and data fields now use `Map<String, Any?>`** instead of `Map<String, String>` or `Map<String, Any>`.

### Affected Components

**43 files were updated** across the framework:

- **Core Communication**: `Comm.data`, `MediaItem.metadata`
- **Tool System**: `Tool.execute()`, `ToolResult.metadata`, `ToolContext.metadata`
- **Graph Execution**: `NodeResult.metadata`, `NodeContext.state`, `HumanResponse.metadata`
- **Handoff System**: `HandoffRequest.metadata`, `HandoffTask.context`
- **Vector Store**: `TextDocument.metadata`, `VectorStore.storeText()`
- **Event Sourcing**: `Snapshot.metadata`

## New Capabilities

### 1. Rich Metadata in Vector Search

Store semantic metadata with proper types:

```kotlin
vectorStore.storeText(
    collectionName = "articles",
    id = "article-123",
    text = "Kotlin is awesome",
    metadata = mapOf(
        "author" to "John Doe",        // String
        "wordCount" to 1500,            // Int
        "rating" to 4.5,                // Double
        "published" to true,            // Boolean
        "tags" to listOf("kotlin", "programming")  // List
    )
)
```

### 2. Type-Safe Tool Parameters

Tools receive properly typed parameters:

```kotlin
override suspend fun execute(params: Map<String, Any?>): SpiceResult<ToolResult> {
    // Safe conversion with validation
    val name = params["name"]?.toString()
        ?: return SpiceResult.failure("Missing 'name'")

    val age = (params["age"] as? Number)?.toInt()
        ?: return SpiceResult.failure("Missing 'age'")

    val active = params["active"] as? Boolean ?: true

    // Work with native types - no parsing needed!
    return if (active && age >= 18) {
        ToolResult.success("Welcome, $name!")
    } else {
        ToolResult.failure("Access denied")
    }
}
```

### 3. JSON Null Support

Handle optional values naturally:

```kotlin
// Explicitly set null values
comm.withData("optionalField", null)

// Check for null
if (comm.data["optionalField"] == null) {
    // Handle missing or null value
}
```

### 4. Safe Accessor Methods

New type-safe convenience methods on `Comm`:

```kotlin
fun Comm.getDataAsString(key: String): String?
fun Comm.getDataAsBoolean(key: String): Boolean?
fun Comm.getDataAsInt(key: String): Int?
fun Comm.getDataAsLong(key: String): Long?
fun Comm.getDataAsDouble(key: String): Double?

// Usage
val userId = comm.getDataAsString("userId") ?: "anonymous"
val retryCount = comm.getDataAsInt("retries") ?: 0
val timeout = comm.getDataAsDouble("timeout") ?: 30.0
```

## Breaking Changes

This is a **major breaking release**. Here's what you need to update:

### 1. Tool Implementations

**Before:**
```kotlin
class MyTool : Tool {
    override suspend fun execute(parameters: Map<String, Any>): SpiceResult<ToolResult> {
        val name = parameters["name"] as String  // Unsafe!
        // ...
    }
}
```

**After:**
```kotlin
class MyTool : Tool {
    override suspend fun execute(parameters: Map<String, Any?>): SpiceResult<ToolResult> {
        val name = parameters["name"]?.toString()
            ?: return SpiceResult.failure("Missing 'name'")
        // ...
    }
}
```

### 2. Metadata Construction

**Before:**
```kotlin
ToolResult.success(
    result = "Done",
    metadata = mapOf(
        "count" to results.size.toString(),  // Force to string
        "success" to "true"
    )
)
```

**After:**
```kotlin
ToolResult.success(
    result = "Done",
    metadata = mapOf(
        "count" to results.size,      // Native Int
        "success" to true,             // Native Boolean
        "timestamp" to System.currentTimeMillis()  // Native Long
    )
)
```

### 3. Serializable Data Classes

Add the custom serializer annotation:

```kotlin
@Serializable
data class MyData(
    @Serializable(with = AnyValueMapSerializer::class)
    val metadata: Map<String, Any?> = emptyMap()
)
```

## Migration Guide

### Quick Start

1. Update to version 0.9.0:
```kotlin
implementation("io.github.noailabs:spice-core:0.9.0")
```

2. Update all Tool implementations to accept `Map<String, Any?>`

3. Replace unsafe casts with safe patterns:
```kotlin
// ‚ùå OLD: Unsafe cast
val value = params["key"] as String

// ‚úÖ NEW: Safe with default
val value = params["key"]?.toString() ?: "default"

// ‚úÖ NEW: Safe with error
val value = params["key"]?.toString()
    ?: throw IllegalArgumentException("Missing 'key'")
```

4. Use native types in metadata:
```kotlin
// Store native types
mapOf(
    "count" to 42,
    "active" to true,
    "score" to 0.95
)
```

5. Use safe accessor methods:
```kotlin
val count = comm.getDataAsInt("count") ?: 0
val enabled = comm.getDataAsBoolean("enabled") == true
```

### Detailed Migration

See our comprehensive [Migration Guide](/docs/migration/v0.9.0) for:
- Step-by-step instructions
- Common patterns and anti-patterns
- Automated migration scripts
- Troubleshooting tips

## Under the Hood

### AnyValueMapSerializer

We've implemented a custom kotlinx.serialization serializer that handles:

- **Null values**: Properly serializes to JsonNull
- **Primitive types**: String, Number, Boolean
- **Collections**: List, Array with recursive handling
- **Type safety**: Automatic validation and conversion

```kotlin
object AnyValueMapSerializer : KSerializer<Map<String, Any?>> {
    // Handles all JSON types transparently
    // null ‚Üí JsonNull
    // primitives ‚Üí JsonPrimitive
    // collections ‚Üí JsonArray
    // complex types ‚Üí toString()
}
```

### NodeResult Null Filtering

`NodeResult.metadata` automatically filters null values when needed:

```kotlin
val merged = (ctx.context.toMap() + additional)
    .filterValues { it != null } as Map<String, Any>
```

This ensures type safety while supporting nullable input.

## Best Practices

### Type Safety Patterns

```kotlin
// ‚úÖ EXCELLENT: Safe accessor with default
val userId = comm.getDataAsString("userId") ?: "anonymous"

// ‚úÖ GOOD: Safe cast with validation
val age = (params["age"] as? Number)?.toInt()
    ?: return Result.failure("Invalid age")

// ‚ùå BAD: Unsafe cast (runtime exception risk)
val userId = comm.data["userId"] as String
```

### Null Handling

```kotlin
// Nullable values are supported
comm.withData("optional", null)  // ‚úÖ Valid

// Check explicitly
val value = comm.data["key"]
if (value != null) {
    // Process non-null value
}
```

## Impact & Testing

- **43 files modified** in spice-core
- **27 test files updated** for type safety
- **23 unsafe casts eliminated**
- **384 tests executed**
- **94.8% pass rate** (20 pre-existing failures unrelated to migration)

## What's Next?

Version 0.9.1 will focus on:
- Enhanced type validation utilities
- Additional safe accessor methods
- Performance optimizations for serialization
- Community feedback integration

## Resources

- [Full Release Notes](/docs/releases/v0.9.0)
- [Migration Guide](/docs/migration/v0.9.0)
- [API Documentation](/docs/api/core)
- [GitHub Changelog](https://github.com/no-ai-labs/spice/compare/v0.8.2...v0.9.0)

## Upgrade Today

This is the most significant update to Spice's type system since launch. The benefits of native types, null safety, and improved JSON compatibility make this upgrade essential for building modern AI applications.

```bash
# Update your dependency
implementation("io.github.noailabs:spice-core:0.9.0")
```

Questions or issues? [Open an issue on GitHub](https://github.com/no-ai-labs/spice/issues) or join our upcoming Discord community.

Happy coding with Spice 0.9.0! üå∂Ô∏è
